<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SudokuMoyo æ•°ç‹¬é˜µåœ°å¯¹å†³ - å¯çˆ±ç‰ˆ</title>
    <!-- å¼•å…¥åœ†æ¶¦å¯çˆ±çš„å­—ä½“ Nunito å’Œ ç«™é…·å¿«ä¹ä½“(é€‚åˆä¸­æ–‡å¡é€š) -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800;900&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #fff9e6; /* å¥¶æ²¹é»„èƒŒæ™¯ */
            --text-color: #5d4037; /* å·§å…‹åŠ›è‰²æ–‡å­— */
            
            /* ç©å®¶é¢œè‰² - ç³–æœè‰²ç³» */
            --red-main: #ff8fa3; /* è‰è“ç²‰ */
            --red-dark: #ff6b85;
            --red-bg: #fff0f3;

            --blue-main: #8ecae6; /* å¤©ç©ºè“ */
            --blue-dark: #6ab7d6;
            --blue-bg: #eaf6ff;

            --grey-main: #e0e0e0;
            --grey-bg: #fcfcfc;

            --board-border-thick: #5d4037; /* åŒºåŸŸç²—è¾¹æ¡†(å·§å…‹åŠ›è‰²) */
            --board-border-thin: #e0cfc0;  /* å†…éƒ¨ç»†è¾¹æ¡†(å¥¶èŒ¶è‰²) */
        }

        body {
            font-family: 'Nunito', 'ZCOOL KuaiLe', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(#e6dbba 2px, transparent 2px);
            background-size: 30px 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: var(--text-color);
            user-select: none;
        }

        /* --- æ ‡é¢˜è®¾è®¡ --- */
        header {
            text-align: center;
            margin-bottom: 20px;
        }

        h1 { 
            margin: 0;
            font-family: 'Nunito', sans-serif;
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            /* å½©è™¹æ¸å˜å­— */
            background: linear-gradient(to bottom right, #ff8fa3, #8ecae6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            /* æè¾¹æ•ˆæœæ¨¡æ‹Ÿ */
            filter: drop-shadow(3px 3px 0px #fff);
            position: relative;
        }
        
        .subtitle {
            display: block;
            font-family: 'ZCOOL KuaiLe', cursive;
            font-size: 1.5rem;
            color: var(--text-color);
            margin-top: 5px;
            text-shadow: 2px 2px 0px rgba(255,255,255,0.8);
        }

        /* --- èœå•ç•Œé¢ --- */
        #start-menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
            align-items: center;
            width: 100%;
        }

        .menu-btn {
            padding: 15px 0;
            width: 260px;
            font-size: 1.4em;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 800;
            font-family: 'ZCOOL KuaiLe', sans-serif; /* ä¸­æ–‡å¡é€šå­—ä½“ */
            color: #fff;
            transition: transform 0.1s;
            position: relative;
            box-shadow: 0 6px 0 rgba(0,0,0,0.1);
        }

        .btn-pve { 
            background-color: var(--blue-main); 
            box-shadow: 0 6px 0 var(--blue-dark);
        }
        .btn-pve:active { 
            transform: translateY(6px); 
            box-shadow: 0 0 0 var(--blue-dark);
        }

        .btn-pvp { 
            background-color: var(--red-main); 
            box-shadow: 0 6px 0 var(--red-dark);
        }
        .btn-pvp:active { 
            transform: translateY(6px); 
            box-shadow: 0 0 0 var(--red-dark);
        }

        .rules-box {
            background: #fff;
            padding: 25px;
            border-radius: 20px;
            border: 3px solid var(--board-border-thick);
            color: var(--text-color);
            font-size: 1.1em;
            max-width: 320px;
            text-align: center;
            box-shadow: 6px 6px 0 rgba(0,0,0,0.1);
            line-height: 1.6;
            font-weight: 700;
            font-family: 'ZCOOL KuaiLe', sans-serif;
        }

        /* --- æ¸¸æˆç•Œé¢ --- */
        #game-ui {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #status-bar {
            margin-bottom: 15px;
            padding: 12px 25px;
            background: #fff;
            border: 3px solid var(--board-border-thick);
            border-radius: 15px;
            text-align: center;
            font-weight: 800;
            font-size: 1.1em;
            width: 90%;
            max-width: 500px;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
        }

        #warning-msg {
            height: 30px;
            margin-bottom: 10px;
            color: #ff6b6b;
            font-weight: 800;
            font-size: 1em;
            text-align: center;
            width: 100%;
            background: rgba(255,255,255,0.6);
            line-height: 30px;
            border-radius: 10px;
        }

        .text-red { color: var(--red-dark); }
        .text-blue { color: var(--blue-dark); }

        /* --- æ£‹ç›˜æ ·å¼ (ä¿®æ”¹ç‰ˆ) --- */
        #game-board {
            display: grid;
            grid-template-columns: repeat(9, 42px);
            grid-template-rows: repeat(9, 42px);
            gap: 0; /* ç§»é™¤é—´éš™ï¼Œä½¿ç”¨è¾¹æ¡†æ§åˆ¶ */
            background-color: #fff;
            /* å¤–å›´æœ€ç²—è¾¹æ¡† */
            border: 4px solid var(--board-border-thick); 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(93, 64, 55, 0.15);
        }

        .cell {
            width: 42px;
            height: 42px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 22px;
            font-weight: 800;
            cursor: pointer;
            background-color: #fff;
            position: relative;
            box-sizing: border-box; /* ç¡®ä¿è¾¹æ¡†ç®—åœ¨å®½åº¦å†… */
            
            /* é»˜è®¤å†…éƒ¨ç»†è¾¹æ¡† */
            border-right: 1px solid var(--board-border-thin);
            border-bottom: 1px solid var(--board-border-thin);
        }

        /* åŒºåŸŸç²—è¾¹æ¡†é€»è¾‘ï¼šè¦†ç›–ç»†è¾¹æ¡† */
        .cell.thick-right { border-right: 3px solid var(--board-border-thick); }
        .cell.thick-bottom { border-bottom: 3px solid var(--board-border-thick); }

        /* ç§»é™¤æœ€åä¸€åˆ—å’Œæœ€åä¸€è¡Œçš„å¤šä½™è¾¹æ¡†(å¯é€‰ï¼Œä½†æœ‰äº†å¤–æ¡†å…¶å®ä¸å½±å“) */
        /* è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šæœ€å³ä¾§å’Œæœ€ä¸‹ä¾§ç”±å®¹å™¨çš„borderæ§åˆ¶ï¼Œcellåªéœ€å¤„ç†å†…éƒ¨ */

        /* åŒºåŸŸèƒŒæ™¯è‰² */
        .zone-red { background-color: var(--red-bg); }
        .zone-blue { background-color: var(--blue-bg); }
        .zone-grey { background-color: var(--grey-bg); }

        .cell:hover:not(.taken):not(.x-mark) {
            filter: brightness(0.95);
            background-color: rgba(0,0,0,0.05);
        }

        /* æ•°å­—å¡«å…¥åŠ¨ç”» */
        .cell.taken { 
            cursor: default; 
            color: var(--text-color);
            animation: jelly 0.5s;
        }

        @keyframes jelly {
            0% { transform: scale(0); }
            25% { transform: scale(1.2); }
            50% { transform: scale(0.9); }
            75% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .cell.taken[data-zone-color="red"] { color: #d6455d; }
        .cell.taken[data-zone-color="blue"] { color: #4a90e2; }

        .cell.x-mark { 
            color: #ff6b6b; 
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            font-size: 26px; 
            cursor: not-allowed; 
            opacity: 0.7;
        }
        
        /* æ§åˆ¶æŒ‰é’® */
        #controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 500px;
        }

        .num-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 800;
            cursor: pointer;
            background: #fff;
            color: var(--text-color);
            box-shadow: 0 4px 0 #ddd;
            transition: all 0.1s;
            font-family: 'Nunito', sans-serif;
        }

        .num-btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 #ddd;
        }

        .num-btn.theme-red {
            border: 2px solid var(--red-main);
            color: var(--red-dark);
        }
        .num-btn.theme-red:hover, .num-btn.theme-red.selected {
            background: var(--red-main);
            color: #fff;
            box-shadow: 0 4px 0 var(--red-dark);
            border-color: var(--red-dark);
        }

        .num-btn.theme-blue {
            border: 2px solid var(--blue-main);
            color: var(--blue-dark);
        }
        .num-btn.theme-blue:hover, .num-btn.theme-blue.selected {
            background: var(--blue-main);
            color: #fff;
            box-shadow: 0 4px 0 var(--blue-dark);
            border-color: var(--blue-dark);
        }

        .num-btn.selected {
            transform: translateY(2px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        #log {
            margin-top: 20px;
            font-size: 0.9em;
            color: #888;
            max-height: 80px;
            overflow-y: auto;
            width: 90%;
            max-width: 400px;
            text-align: center;
            background: #fff;
            padding: 10px;
            border-radius: 10px;
            border: 2px dashed #ccc;
        }

        #back-btn {
            margin-top: 25px;
            padding: 10px 25px;
            background-color: #fff;
            color: #888;
            border: 2px solid #ccc;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 800;
            transition: 0.2s;
            font-family: 'ZCOOL KuaiLe', sans-serif;
        }
        #back-btn:hover { 
            background-color: #f0f0f0;
            color: #555;
            border-color: #bbb;
        }

        ::-webkit-scrollbar { width: 0px; }

    </style>
</head>
<body>

    <header>
        <h1>SudokuMoyo</h1>
        <span class="subtitle">æ•°ç‹¬é˜µåœ°å¯¹å†³</span>
    </header>

    <!-- å¼€å§‹èœå• -->
    <div id="start-menu">
        <button class="menu-btn btn-pve" onclick="startGame('pve')">ğŸ‘¤ äººæœºå¯¹æˆ˜</button>
        <button class="menu-btn btn-pvp" onclick="startGame('pvp')">ğŸ‘¥ åŒäººå¯¹æˆ˜</button>
        <div class="rules-box">
            <div style="font-size:1.2em; margin-bottom:10px;">ğŸ“– æ¸¸æˆè§„åˆ™</div>
            <span style="color:var(--text-color); opacity:0.7;">é˜¶æ®µä¸€ï¼š</span> æŠ¢å ä¸­é—´çš„ç°è‰²EåŒº<br>
            <span style="color:var(--text-color); opacity:0.7;">é˜¶æ®µäºŒï¼š</span> åªèƒ½å¡«è‡ªå·±çš„é¢œè‰²åŒºåŸŸ<br>
            <br>
            âŒ æ²¡åœ°æ–¹å¡«å°±ç®—è¾“å•¦ï¼
        </div>
    </div>

    <!-- æ¸¸æˆä¸»ç•Œé¢ -->
    <div id="game-ui">
        <div id="status-bar">æ­£åœ¨å‡†å¤‡æ£‹ç›˜...</div>
        <div id="warning-msg"></div>

        <div id="game-board"></div>

        <div id="controls">
            <button class="num-btn" onclick="selectNumber(1)">1</button>
            <button class="num-btn" onclick="selectNumber(2)">2</button>
            <button class="num-btn" onclick="selectNumber(3)">3</button>
            <button class="num-btn" onclick="selectNumber(4)">4</button>
            <button class="num-btn" onclick="selectNumber(5)">5</button>
            <button class="num-btn" onclick="selectNumber(6)">6</button>
            <button class="num-btn" onclick="selectNumber(7)">7</button>
            <button class="num-btn" onclick="selectNumber(8)">8</button>
            <button class="num-btn" onclick="selectNumber(9)">9</button>
        </div>

        <div id="log"></div>

        <button id="back-btn" onclick="showMenu()">è¿”å›ä¸»èœå•</button>
    </div>

<script>
    // --- æ¸¸æˆé…ç½®ä¸çŠ¶æ€ ---
    const ZONE_MAP = {
        'A': {r:0, c:0}, 'B': {r:0, c:3}, 'C': {r:0, c:6},
        'D': {r:3, c:0}, 'E': {r:3, c:3}, 'F': {r:3, c:6},
        'G': {r:6, c:0}, 'H': {r:6, c:3}, 'I': {r:6, c:6}
    };

    const RED_ZONES = ['A', 'C', 'D', 'H'];
    const BLUE_ZONES = ['B', 'F', 'G', 'I'];
    
    let board = []; 
    let gameMode = 'pve'; 
    let turnColor = 'red'; 
    let myPlayerColor = ''; 
    let currentPhase = 1; 
    let selectedNum = null;
    let gameOver = false;

    function showMenu() {
        document.getElementById('start-menu').style.display = 'flex';
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('warning-msg').innerText = "";
    }

    function startGame(mode) {
        gameMode = mode;
        document.getElementById('start-menu').style.display = 'none';
        document.getElementById('game-ui').style.display = 'flex';
        initGame();
    }

    function initGame() {
        board = Array(81).fill(0);
        gameOver = false;
        currentPhase = 1;
        selectedNum = null;
        document.getElementById('log').innerHTML = "âœ¨ æ¸¸æˆå¼€å§‹å•¦ï¼";
        clearWarning();

        turnColor = Math.random() > 0.5 ? 'red' : 'blue';

        if (gameMode === 'pve') {
            myPlayerColor = Math.random() > 0.5 ? 'red' : 'blue';
            let playerText = myPlayerColor==='red' ? 'çº¢æ–¹' : 'è“æ–¹';
            let cssClass = myPlayerColor==='red' ? 'text-red' : 'text-blue';
            log(`æ¨¡å¼ï¼šäººæœºå¯¹æˆ˜ã€‚ä½ æ˜¯ <span class="${cssClass}"><b>${playerText}</b></span>`);
        } else {
            log("æ¨¡å¼ï¼šåŒäººå¯¹æˆ˜ã€‚");
        }

        fillInitialBoard();
        renderBoard();
        updateXMarks();
        updateUIState();
        checkCpuMove();
    }

    function checkCpuMove() {
        if (gameOver) return;
        if (gameMode === 'pve' && turnColor !== myPlayerColor) {
            setTimeout(cpuMove, 1000); 
        }
    }

    function getZoneId(r, c) {
        let zr = Math.floor(r / 3);
        let zc = Math.floor(c / 3);
        const zones = [['A', 'B', 'C'], ['D', 'E', 'F'], ['G', 'H', 'I']];
        return zones[zr][zc];
    }

    function getZoneColorClass(zoneId) {
        if (RED_ZONES.includes(zoneId)) return 'zone-red';
        if (BLUE_ZONES.includes(zoneId)) return 'zone-blue';
        return 'zone-grey';
    }
    
    function getZoneLogicColor(zoneId) {
        if (RED_ZONES.includes(zoneId)) return 'red';
        if (BLUE_ZONES.includes(zoneId)) return 'blue';
        return 'grey';
    }

    function isValidMove(r, c, num, currentBoard) {
        for (let i = 0; i < 9; i++) { if (currentBoard[r * 9 + i] === num) return false; }
        for (let i = 0; i < 9; i++) { if (currentBoard[i * 9 + c] === num) return false; }
        let startR = Math.floor(r / 3) * 3;
        let startC = Math.floor(c / 3) * 3;
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                if (currentBoard[(startR + i) * 9 + (startC + j)] === num) return false;
            }
        }
        return true;
    }

    function fillInitialBoard() {
        function fillZone(zones, min, max) {
            zones.forEach(z => {
                let count = Math.floor(Math.random() * (max - min + 1)) + min;
                let filled = 0; let attempts = 0;
                let startR = ZONE_MAP[z].r; let startC = ZONE_MAP[z].c;
                while (filled < count && attempts < 100) {
                    attempts++;
                    let rr = startR + Math.floor(Math.random() * 3);
                    let cc = startC + Math.floor(Math.random() * 3);
                    let idx = rr * 9 + cc;
                    if (board[idx] === 0) {
                        let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
                        for (let n of nums) {
                            if (isValidMove(rr, cc, n, board)) {
                                board[idx] = n; filled++; break;
                            }
                        }
                    }
                }
            });
        }
        fillZone(['E'], 2, 5);
        fillZone(RED_ZONES, 2, 4);
        fillZone(BLUE_ZONES, 2, 4);
    }

    function updateXMarks() {
        let changed = false;
        for (let i = 0; i < 81; i++) {
            if (board[i] === 0) {
                let r = Math.floor(i / 9); let c = i % 9;
                let canFill = false;
                for (let n = 1; n <= 9; n++) {
                    if (isValidMove(r, c, n, board)) { canFill = true; break; }
                }
                if (!canFill) {
                    board[i] = -1; changed = true;
                    let cell = document.querySelector(`.cell[data-idx='${i}']`);
                    if (cell) { cell.innerText = 'Ã—'; cell.classList.add('x-mark'); }
                }
            }
        }
        return changed;
    }

    function checkPhase() {
        if (currentPhase === 1) {
            let startR = 3, startC = 3;
            let eFull = true;
            for(let i=0; i<3; i++){
                for(let j=0; j<3; j++){
                    if(board[(startR+i)*9 + (startC+j)] === 0) { eFull = false; break; }
                }
            }
            if (eFull) {
                currentPhase = 2;
                log("ğŸ‰ é˜¶æ®µä¸€ç»“æŸï¼è¿›å…¥é˜²å®ˆé˜¶æ®µã€‚");
                showWarning("è¿›å…¥é˜¶æ®µäºŒï¼šé˜²å®ˆè‡ªå·±çš„é˜µåœ°ï¼");
            }
        }
    }

    function hasValidMove(who) {
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                if (board[r * 9 + c] !== 0) continue;
                let zone = getZoneId(r, c);
                if (currentPhase === 1) {
                    if (zone !== 'E') continue;
                } else {
                    if (who === 'red' && !RED_ZONES.includes(zone)) continue;
                    if (who === 'blue' && !BLUE_ZONES.includes(zone)) continue;
                }
                for (let n = 1; n <= 9; n++) {
                    if (isValidMove(r, c, n, board)) return true;
                }
            }
        }
        return false;
    }

    function renderBoard() {
        const container = document.getElementById('game-board');
        container.innerHTML = '';
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                let idx = r * 9 + c;
                let div = document.createElement('div');
                let zoneId = getZoneId(r, c);
                div.className = `cell ${getZoneColorClass(zoneId)}`;
                
                // ç²—è¾¹æ¡†é€»è¾‘ - æ¸…æ™°åˆ’åˆ†9å¤§åŒºåŸŸ
                // æ¯3åˆ—çš„å³è¾¹åŠ ç²— (é™¤äº†æœ€åä¸€åˆ—)
                if ((c + 1) % 3 === 0 && c < 8) div.classList.add('thick-right');
                // æ¯3è¡Œçš„ä¸‹è¾¹åŠ ç²— (é™¤äº†æœ€åä¸€è¡Œ)
                if ((r + 1) % 3 === 0 && r < 8) div.classList.add('thick-bottom');

                div.dataset.r = r; div.dataset.c = c; div.dataset.idx = idx;
                div.onclick = () => handleCellClick(r, c);
                
                if (board[idx] > 0) { 
                    div.innerText = board[idx]; 
                    div.classList.add('taken'); 
                    div.dataset.zoneColor = getZoneLogicColor(zoneId);
                }
                else if (board[idx] === -1) { div.innerText = 'Ã—'; div.classList.add('x-mark'); }
                
                container.appendChild(div);
            }
        }
    }

    function selectNumber(n) {
        if (gameOver) return;
        if (gameMode === 'pve' && turnColor !== myPlayerColor) return;

        selectedNum = n;
        clearWarning();
        updateButtonStyles();
    }

    function updateButtonStyles() {
        let btns = document.querySelectorAll('.num-btn');
        let themeClass = turnColor === 'red' ? 'theme-red' : 'theme-blue';

        btns.forEach((b, i) => {
            b.className = 'num-btn';
            b.classList.add(themeClass);
            if ((i + 1) === selectedNum) {
                b.classList.add('selected');
            }
        });
    }

    function updateStatus() {
        let sb = document.getElementById('status-bar');
        let phaseText = currentPhase === 1 ? "äº‰å¤ºä¸­é—´(E)" : "ä¿å«é˜µåœ°";
        let turnName = turnColor === 'red' ? "çº¢æ–¹" : "è“æ–¹";
        let colorClass = turnColor === 'red' ? "text-red" : "text-blue";
        
        let statusText = "";
        
        if (gameMode === 'pve') {
            if (turnColor === myPlayerColor) {
                statusText = `<span class="${colorClass}">è½®åˆ°ä½ å•¦ (${turnName})</span>`;
            } else {
                statusText = `<span class="${colorClass}" style="opacity:0.7">ç”µè„‘æ€è€ƒä¸­ (${turnName})...</span>`;
            }
        } else {
            statusText = `<span class="${colorClass}">ç©å®¶ ${turnName} å›åˆ</span>`;
        }

        sb.innerHTML = `é˜¶æ®µ: ${phaseText} | ${statusText}`;
    }

    function updateUIState() {
        updateStatus();
        updateButtonStyles();
    }

    function handleCellClick(r, c) {
        clearWarning();
        if (gameOver) return;
        
        if (gameMode === 'pve' && turnColor !== myPlayerColor) {
            showWarning("å˜˜... ç”µè„‘æ­£åœ¨æ€è€ƒå‘¢");
            return;
        }

        if (board[r*9+c] !== 0) { showWarning("è¿™ä¸ªæ ¼å­å·²ç»è¢«å å•¦"); return; }
        if (!selectedNum) { showWarning("å…ˆé€‰ä¸€ä¸ªæ•°å­—å§ï¼"); return; }

        let zone = getZoneId(r, c);
        if (currentPhase === 1) {
            if (zone !== 'E') { showWarning("é˜¶æ®µä¸€åªèƒ½å¡«ä¸­é—´çš„ E åŒºå“¦"); return; }
        } else {
            let allowed = turnColor === 'red' ? RED_ZONES : BLUE_ZONES;
            if (!allowed.includes(zone)) {
                let colorName = turnColor === 'red' ? 'çº¢æ–¹' : 'è“æ–¹';
                showWarning(`åªèƒ½å¡«è‡ªå·±çš„ ${colorName} åŒºåŸŸå“¦`);
                return;
            }
        }

        if (!isValidMove(r, c, selectedNum, board)) {
            showWarning(`å“å‘€ï¼Œæ•°å­— ${selectedNum} å†²çªå•¦ï¼`);
            return;
        }

        makeMove(r, c, selectedNum);
    }

    function makeMove(r, c, num) {
        board[r*9+c] = num;
        
        let cell = document.querySelector(`.cell[data-idx='${r*9+c}']`);
        cell.innerText = num;
        cell.classList.add('taken');
        cell.dataset.zoneColor = getZoneLogicColor(getZoneId(r, c));

        selectedNum = null;
        updateXMarks();
        checkPhase();

        turnColor = turnColor === 'red' ? 'blue' : 'red';
        
        if (!hasValidMove(turnColor)) {
            let winner = turnColor === 'red' ? 'blue' : 'red'; 
            endGame(winner);
            return;
        }

        updateUIState();
        checkCpuMove();
    }

    function cpuMove() {
        if (gameOver) return;

        let moves = [];
        for (let r = 0; r < 9; r++) {
            for (let c = 0; c < 9; c++) {
                if (board[r*9+c] !== 0) continue;
                let zone = getZoneId(r, c);

                if (currentPhase === 1) {
                    if (zone !== 'E') continue;
                } else {
                    let allowed = turnColor === 'red' ? RED_ZONES : BLUE_ZONES;
                    if (!allowed.includes(zone)) continue;
                }

                for (let n = 1; n <= 9; n++) {
                    if (isValidMove(r, c, n, board)) moves.push({r,c,n});
                }
            }
        }

        if (moves.length === 0) {
            endGame(turnColor === 'red' ? 'blue' : 'red');
            return;
        }

        let m = moves[Math.floor(Math.random() * moves.length)];
        makeMove(m.r, m.c, m.n);
    }

    function endGame(winnerColor) {
        gameOver = true;
        let sb = document.getElementById('status-bar');
        let winText = winnerColor === 'red' ? "çº¢æ–¹" : "è“æ–¹";
        let colorClass = winnerColor === 'red' ? "text-red" : "text-blue";

        let msg = "";
        if (gameMode === 'pve') {
            if (winnerColor === myPlayerColor) {
                msg = `<span style="color:#4caf50;">ğŸ‰ æ­å–œï¼ä½ èµ¢å•¦ï¼</span>`;
            } else {
                msg = `<span style="color:#ff6b6b;">ğŸ¤– å“å‘€ï¼Œä½ è¾“å•¦ï¼</span>`;
            }
        } else {
            msg = `<span class="${colorClass}">ğŸ† ${winText} èƒœåˆ©ï¼</span>`;
        }
        
        sb.innerHTML = msg;
        document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
    }

    function showWarning(msg) { 
        let el = document.getElementById('warning-msg');
        el.innerText = msg;
    }
    function clearWarning() { document.getElementById('warning-msg').innerText = ""; }
    function log(msg) { 
        let l = document.getElementById('log'); 
        l.innerHTML = `<div>${msg}</div>` + l.innerHTML; 
    }

</script>

</body>
</html>